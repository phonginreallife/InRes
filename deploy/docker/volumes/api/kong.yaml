_format_version: '2.1'
_transform: true

###
### Consumers / Users
###
consumers:
  - username: DASHBOARD

###
### API Routes
###
services:
  ## API Service - Main Backend API
  - name: api-service
    _comment: 'API: /api/* -> http://api:8080/*'
    url: http://api:8080/
    routes:
      - name: api-routes
        strip_path: true
        paths:
          - /api
    plugins:
      - name: cors

  ## AI Agent Service
  - name: agent-service
    _comment: 'AI: /ai/* -> http://agent:8002/*'
    url: http://agent:8002/
    routes:
      - name: agent-routes
        strip_path: true
        paths:
          - /ai/
    plugins:
      - name: cors

  ## WebSocket for AI Chat (block streaming)
  - name: agent-websocket
    _comment: 'WebSocket: /ws/chat -> ws://agent:8002/ws/chat'
    url: http://agent:8002
    protocol: ws
    routes:
      - name: ai-ws-route
        strip_path: false
        paths:
          - /ws/chat
    plugins:
      - name: cors

  ## WebSocket for AI Stream (token streaming)
  - name: agent-stream-websocket
    _comment: 'WebSocket: /ws/stream -> ws://agent:8002/ws/stream'
    url: http://agent:8002
    protocol: ws
    routes:
      - name: ai-stream-ws-route
        strip_path: false
        paths:
          - /ws/stream
    plugins:
      - name: cors
  
  ## WebSocket for AI Terminal
  - name: ai-terminal-websocket
    _comment: 'WebSocket: /ws/terminal?session_id=xxx -> ws://terminal:8003/ws/terminal?session_id=xxx'
    url: http://terminal:8003
    protocol: ws
    routes:
      - name: ai-terminal-ws-route
        strip_path: false
        paths:
          - /ws/terminal
    plugins:
      - name: cors

  ## Webhook Service - External Integrations (PagerDuty, etc.)
  - name: webhook-service
    _comment: 'Webhook: /webhook/* -> http://api:8080/webhook/*'
    url: http://api:8080/
    routes:
      - name: webhook-routes
        strip_path: false
        paths:
          - /webhook
    plugins:
      - name: cors

  ## Web Frontend
  - name: web-service
    _comment: 'Web: /* -> http://web:3000/*'
    url: http://web:3000/
    routes:
      - name: web-routes
        strip_path: false
        paths:
          - /
    plugins:
      - name: cors
